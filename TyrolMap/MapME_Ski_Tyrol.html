<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>MapME - Tyrol</title>

	<!-- Own Style -->
	<link rel="stylesheet" href="./styles/style.css" />
	<link rel="stylesheet" href="./styles/style_buttons.css" />
	<link rel="stylesheet" href="./styles/style_loader.css" />

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	
	<!-- Include the CesiumJS JavaScript and CSS files -->
	<script src="https://cesium.com/downloads/cesiumjs/releases/1.99/Build/Cesium/Cesium.js"></script>
	<link href="https://cesium.com/downloads/cesiumjs/releases/1.99/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
	
</head>
<body>

<div id="loadingDiv" class="loader" alt="Loader">
	<img id="loading-image" class="loader_image" src="./files/MapME.jpg" alt="Loading..." />
	<div id="loader_gifDiv" class="loader_gif"></div>
</div>

<div id="disclaimerDiv" class="disclaimer">
	<div id="disclaimer_text" class="disclaimer_text" alt="Disclaimer" />
	<h1>Welcome to MapME!</h1>
	<p>We are working on this mapping application in our leisure time for fun.
	Hence, you are free to use it the way you like as long as you credit us properly and help spreading the message!<br/></p>
	<p>Please note that all information provided by this tool is experimental and we explicitely exclude any responsibility of ours for the things you are doing with it!</p>
	<p>We are changing credentials for our datasets regularly in an irregular manner such that there is no possibility to misuse them except you have some very fancy tricks.
	If you still should try to misuse our service, we will find out and take care of it/you!</p>
	<p><b>Best<br/>Michael Engel</b></p>
	<button id="disclaimerbutton_acceptDiv" class="button_accept">ACCEPT</button><button id="disclaimerbutton_declineDiv" class="button_decline">DECLINE</button>
	</div>
</div>

<div id="welcomeDiv" class="welcome">
	<div id="welcome_text" class="welcome_text" alt="Welcome"/>
	<h1 style="text-align:center">Keep your enthusiasm!</h1>
	<img src='./files/FaceME.jpg' style='max-width:90vmin;max-height:90vmin'/>
	</div>
</div>

<div id="cesiumContainer" style="width:100%;height:100%;"></div>
<script>
  	// ### Predefinitions for Viewer ###
  	Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwNmQ2ZTQ5ZS0zMjZlLTQ2ZjMtOTMxYy02YjM3ZmQ2ZjgwMDIiLCJpZCI6ODE1OTUsImlhdCI6MTY0NDIxODI4OH0.qnvoYt8vjupU8UXaRGZeBq8OPa1Mqfb9cq-ETU1TxVI"

	// ## Parse URL ##
    const baseurl = (' '+document.URL.split("?")[0]).slice(1);
    const queryString = window.location.search;
	var urlParams = new URLSearchParams(queryString);
	urlParams.forEach(console.log)
	var camera_x = urlParams.get('lon')
	if (!camera_x) {
		camera_x = 10.9337
	}
	var camera_y = urlParams.get('lat')
	if (!camera_y) {
		camera_y = 47.23 // 47.3603
	}
	var camera_z = urlParams.get('z')
	if (!camera_z) {
		camera_z = 16000
	}
	var camera_heading = urlParams.get('heading')
	if (!camera_heading) {
		camera_heading = 360
	}
	var camera_pitch = urlParams.get('pitch')
	if (!camera_pitch) {
		camera_pitch = -45
	}

  	// ## Search Engine ##
	function OpenStreetMapNominatimGeocoder() {}
    OpenStreetMapNominatimGeocoder.prototype.geocode = function (input) {
  		var endpoint = "https://nominatim.openstreetmap.org/search";
  		var resource = new Cesium.Resource({
			url: endpoint,
			queryParameters: {
  				format: "json",
  				q: input,
			},
  		});

  		return resource.fetchJson().then(function (results) {
			var bboxDegrees;
			return results.map(function (resultObject) {
  				bboxDegrees = resultObject.boundingbox;
  				return {
				displayName: resultObject.display_name,
				destination: Cesium.Rectangle.fromDegrees(
  					bboxDegrees[2],
  					bboxDegrees[0],
  					bboxDegrees[3],
  					bboxDegrees[1]
				),
  				};
			});
  		});
	};
	
	// ### DEFINE VIEWER ###
	// ## Basic Definition ##
    const viewer = new Cesium.Viewer('cesiumContainer', {	
      	terrainProvider: new Cesium.CesiumTerrainProvider({
                            url: Cesium.IonResource.fromAssetId(952656),
                         }),//Cesium.createWorldTerrain(),
		imageryProvider: false,
  		homeButton: true,
		fullscreenButton: true,
		CreditsDisplay: true,
		infoBox: false,
  		geocoder: new OpenStreetMapNominatimGeocoder(),
	  	sceneMode: Cesium.SceneMode.SCENE3D,
  		sceneModePicker: true,
  		navigationHelpButton: true,
	  	animation: false,
		timeline: false,
		baseLayerPicker: false,
		useBrowserRecommendedResolution: false,
	});
	viewer._cesiumWidget._creditContainer.parentNode.removeChild(
        viewer._cesiumWidget._creditContainer
	);
	viewer.scene.globe.baseColor = Cesium.Color.WHITE;

    // ## Terrain Exaggeration for better visibility ##
	viewer.scene.globe.terrainExaggeration = 1;//Math.sqrt(2);

    // ## Camera ##
	// # home #
	var extent = Cesium.Rectangle.fromDegrees(10.08,46.63,12.98,47.75);
	Cesium.Camera.DEFAULT_VIEW_RECTANGLE = extent;

	// # start #
	viewer.camera.flyTo({
		destination: Cesium.Cartesian3.fromDegrees(camera_x, camera_y, camera_z),
		orientation: {
			heading: Cesium.Math.toRadians(camera_heading),
			pitch: Cesium.Math.toRadians(camera_pitch),
			roll: 0.0,
    	},
	});

	// # Camera Position URL #
	viewer.camera.moveEnd.addEventListener(function() { 
		var lonlatz = Cesium.Cartographic.fromCartesian(viewer.camera.position);
		newurl = baseurl+`?lon=${Cesium.Math.toDegrees(lonlatz.longitude)}&lat=${Cesium.Math.toDegrees(lonlatz.latitude)}&z=${lonlatz.height}&heading=${Cesium.Math.toDegrees(viewer.camera.heading)}&pitch=${Cesium.Math.toDegrees(viewer.camera.pitch)}`
		window.history.replaceState('', '', newurl);
	});

	// ### LIMIT VIEW ###
    
    //navigator.geolocation.getCurrentPosition(alert); # get position of user

	// ### DEFINE LAYERS ###
	// ## Baselayer ##
	WMTS_OpenStreetMap = new Cesium.OpenStreetMapImageryProvider({
		url : 'https://a.tile.openstreetmap.org/',
    });
	// ## Bergfex ##
	WMTS_Bergfex = new Cesium.OpenStreetMapImageryProvider({
		url : 'http://maps.bergfex.at/osm/standard/',
		fileExtension : "jpg",
    });

	// ## Tyrol ##
	WMS_hillshadeDSM_1m_Tirol = new Cesium.WebMapServiceImageryProvider({
		url: "https://gis.tirol.gv.at/arcgis/services/Service_Public/terrain/MapServer/WMSServer",
		parameters: {
			format: "image/jpeg",
			layers: "Image_Schummerung_Oberflaechenmodell",
			dpiMode: 3,
		},
		minimalLevel: 1,
		maximalLevel: 16,
		credit: new Cesium.Credit("OpenData Tirol"),
        });

	WMS_contours20m_Tirol = new Cesium.WebMapServiceImageryProvider({
		url: "https://gis.tirol.gv.at/arcgis/services/Service_Public/terrain/MapServer/WMSServer",
		parameters: {
			format: "image/png",
			layers: "Hoehenschichtlinien_20m",
			dpiMode: 3,
		},
		minimalLevel: 1,
		maximalLevel: 16,
		credit: new Cesium.Credit("OpenData Tirol"),
	});

	WMS_slope_Tirol = new Cesium.WebMapServiceImageryProvider({
		url: "https://gis.tirol.gv.at/arcgis/services/Service_Public/terrain/MapServer/WMSServer",
		parameters: {
			format: "image/png",
			layers: "Image_Gelaendeneigung_Wintersport,Hoehenschichtlinien_20m",
			layers_opacity: "1,0.3,1",
			dpiMode: 3,
		},
		minimalLevel: 1,
		maximalLevel: 16,
		credit: new Cesium.Credit("OpenData Tirol"),
        });
	
	// ## Standard layer
	WMS_hillshadeDSM_1m_Tirol_layer = viewer.imageryLayers.addImageryProvider(WMS_hillshadeDSM_1m_Tirol);
	WMS_hillshadeDSM_1m_Tirol_layer.alpha = 1;
	WMS_hillshadeDSM_1m_Tirol_layer.gamma = 1;
	WMS_hillshadeDSM_1m_Tirol_layer.saturation = 1;
	WMS_hillshadeDSM_1m_Tirol_layer.brightness = 1;

	WMTS_OpenStreetMap_layer = viewer.imageryLayers.addImageryProvider(WMTS_OpenStreetMap);
	WMTS_OpenStreetMap_layer.alpha = 0.6;
	WMTS_OpenStreetMap_layer.contrast = 1.5;
	WMTS_OpenStreetMap_layer.saturation = 2.5;
	//WMTS_OpenStreetMap_layer.hue = 210/360;
	WMTS_OpenStreetMap_layer.brightness = 0.8;
	
	//WMS_contours20m_Tirol_layer = viewer.imageryLayers.addImageryProvider(WMS_contours20m_Tirol);
	//WMS_contours20m_Tirol_layer.minificationFilter = Cesium.TextureMinificationFilter.NEAREST
	//WMS_contours20m_Tirol_layer.maxificationFilter = Cesium.TextureMinificationFilter.NEAREST
	//WMS_contours20m_Tirol_layer.alpha = 0.6;
	//WMS_contours20m_Tirol_layer.contrast = 2;
	//WMS_contours20m_Tirol_layer.saturation = 100;
	//WMS_contours20m_Tirol_layer.brightness = 1;
	//WMS_contours20m_Tirol_layer.colorToAlpha = Cesium.Color.WHITE;//new Cesium.Color(0.0, 0.0, 0.0, 1.0);
	//WMS_contours20m_Tirol_layer.colorToAlphaThreshold = 0.12;
	//WMS_contours20m_Tirol_layer.hue = 210/360;

	//WMTS_Bergfex_layer = viewer.imageryLayers.addImageryProvider(WMTS_Bergfex);
	//WMTS_Bergfex_layer.alpha = 0;

	WMS_slope_Tirol_layer = viewer.imageryLayers.addImageryProvider(WMS_slope_Tirol);
	WMS_slope_Tirol_layer.alpha = 0.33;
	WMS_slope_Tirol_layer.saturation = 1;
	WMS_slope_Tirol_layer.colorToAlpha = Cesium.Color.WHITE;
	WMS_slope_Tirol_layer.colorToAlphaThreshold = 0.04;

	// ### SkitourenguruTracks ###
	// ## pad fun ##
	function pad(num, size) {
		num = num.toString();
		while (num.length < size) num = "0" + num;
		return num;
	}
	// ## add tracks ##
	for (let i=1; i<999; i++) {
		gpx = Cesium.GpxDataSource.load(
			`https://skitourenguru.ch/calc_data2/gpx/Austria_ID${pad(i,6)}.gpx`,
			{
				clampToGround: true,
				routeColor: Cesium.Color.CYAN,
				trackColor: Cesium.Color.CYAN,
				waypointImage: false,
			}
		)

		entity = viewer.dataSources.add(gpx)
		.then(
			function(dataSource) {
				dataSource.entities._entities._array[0]._name = `https://skitourenguru.ch/track-view?area=au&id=${i}`;
			}
		)
	}

	// ## add handler for visiting Skitourenguru ##
	handler_skitourenguru = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
	handler_skitourenguru.setInputAction(
		function(click) {
			let feature = viewer.scene.pick(click.position);
			if (Cesium.defined(feature)) {
				var answer = confirm(`Leave this page to ${feature.id._name}?`);
				if (answer) {
					console.log('Visiting '+feature.id._name);
					window.open(feature.id._name);
				}
				else {
					alert ("Please consider visiting skitourenguru.ch!");
				}
			}
		}, 
		Cesium.ScreenSpaceEventType.LEFT_CLICK 
	);

	//#############################################################################
	//### BUTTONS #################################################################
	//#############################################################################	
	$(disclaimerbutton_acceptDiv).on('click', function(){
		removeDiv($("#disclaimerDiv"));
		showDiv($("#welcomeDiv"));
		setTimeout(removeWelcome,2000);
	});
	function removeWelcome(){
		removeDiv($("#welcomeDiv"))
	}

	$(disclaimerbutton_declineDiv).on('click', function(){
		hideDiv($("#cesiumContainer"));
		removeDiv($("#welcomeDiv"));
		removeDiv($("#disclaimerDiv"));
		removeDiv($("#cesiumContainer"));
	});

	//#############################################################################
	//### LOADER ##################################################################
	//#############################################################################
	$(window).on('load', function(){
		setTimeout(removeLoader, 2500);
	});
	function removeLoader(){
		hideDiv($("#welcomeDiv"))
		removeDiv($("#loadingDiv"))
	}

	//#############################################################################
	//### UTILS ###################################################################
	//#############################################################################
	function removeDiv(Div){
		Div.fadeOut(500, function() {
			Div.remove();
		});  
	}
	function showDiv(Div){
		Div.show()
	}
	function hideDiv(Div){
		Div.hide()
	}
</script>
</div>
</body>
</html>